===============================================================================
                   LIVE2D EXTENSION - АРХИТЕКТУРНАЯ ДОКУМЕНТАЦИЯ
===============================================================================

ИНСТРУКЦИЯ ДЛЯ CLAUDE:
======================
Этот файл содержит полную документацию систем расширения Live2D.
Перед работой с кодом ОБЯЗАТЕЛЬНО изучите архитектуру и настройки.

ПРИ ДОБАВЛЕНИИ НОВЫХ СИСТЕМ:
- Добавьте описание в соответствующую секцию
- Обновите список файлов и API
- Документируйте все настройки с диапазонами значений

===============================================================================
СТРУКТУРА ФАЙЛОВ
===============================================================================

ОСНОВНЫЕ МОДУЛИ:
• index.js - точка входа, инициализация, настройки по умолчанию
• live2d.js - управление моделями, анимации, автоматические системы
• ui.js - интерфейс пользователя и обработчики событий  
• window.html - HTML разметка интерфейса
• bodyMovement.js - продвинутая система движений тела
• eyeBlink.js - реалистичная система моргания глазами
• constants.js - константы, настройки API, библиотеки
• utils.js - вспомогательные функции

ДОПОЛНИТЕЛЬНЫЕ:
• gallery/ - система выбора моделей с предпросмотром
  ├── gallery.js - функции галереи
  └── galleryDlg.html - диалог выбора

СТРУКТУРА ДАННЫХ:
• extension_settings.live2d.* - все настройки расширения
• models[character] - загруженные модели по персонажам
• autoAnimationsRunning[character] - состояние автоанимаций
• bodyMovementStates[character] - состояния системы движения тела

===============================================================================
СИСТЕМА АВТОМАТИЧЕСКИХ АНИМАЦИЙ
===============================================================================

АЛГОРИТМ ДВИЖЕНИЙ ГЛАЗ:
• Саккады-фиксации с центральными/периферийными зонами
• Использует setParameterValueById для абсолютных позиций
• Центральные движения (малая амплитуда) vs периферийные (большая амплитуда)

МИКРОСАККАДЫ:
• Мелкие случайные движения поверх основных движений глаз
• Независимая частота, амплитуда и длительность
• Добавляют реализм и "живость" взгляду

НАСТРОЙКИ:
• autoAnimationsEnabled: bool, по умолчанию true
• autoEyeCenterWeight: 0-100%, вес периферийных движений, по умолчанию 70%
• autoEyeAmplitudeCenter: 0.001-2.0, амплитуда центральной зоны, по умолчанию 0.05
• autoEyeAmplitudePeripheral: 0.0-1.0, амплитуда периферии, по умолчанию 0.2
• autoEyeFixationMin/Max: 100-1000/500-3000мс, время фиксации, по умолчанию 200/2000мс
• microsaccadesEnabled: bool, по умолчанию true
• microsaccadeAmplitude: 0.001-0.1, сила микросаккад, по умолчанию 0.02
• microsaccadeFrequency: 0.1-3.0, частота, по умолчанию 1.0
• microsaccadeDuration: 5-50мс, длительность, по умолчанию 15мс
• microsaccadeIntervalMin/Max: 100-1000/500-3000мс, интервалы, по умолчанию 300/1500мс

API:
• startAutoAnimations(character) - запуск всех автоанимаций
• stopAutoAnimations(character) - остановка
• restartAutoAnimations(character) - перезапуск с новыми настройками

===============================================================================
СИСТЕМА ДВИЖЕНИЙ ТЕЛА (BODY MOVEMENT)
===============================================================================

АРХИТЕКТУРА:
• Состояния: idle (покой) / talking (разговор)
• Переключение: через notifyMouthActivity(character, isActive)
• Мониторинг рта: отслеживание РЕАЛЬНОГО значения параметра рта (не флаги)

КОМПОНЕНТЫ ДВИЖЕНИЯ:
1. Многослойный шум (медленный/средний/быстрый) - базовые плавные движения
2. Импульсы - резкие случайные движения
3. Физическая симуляция - пружина + демпфер для инерции
4. Корреляция параметров - взаимосвязь движений для естественности

IDLE РЕЖИМ (покой):
• Редкие слабые импульсы (minInterval 3000мс)
• Больше медленного шума, меньше быстрого
• Повышенное демпфирование, мягкая пружина

TALKING РЕЖИМ (разговор):
• Частые сильные импульсы (minInterval 300мс)
• Усиление импульсов через Talking Impulse Multiplier
• Ускорение шумов через Talking Speed Boost
• Увеличенная частота импульсов (Talking Impulse Frequency)

НАСТРОЙКИ ИНТЕНСИВНОСТИ:
• bodyMovementEnabled: bool, по умолчанию true
• bodyMovementIdleIntensity: 0-1, интенсивность шумов в покое, по умолчанию 0.3
• bodyMovementTalkingIntensity: 0-1, интенсивность шумов при разговоре, по умолчанию 0.6

НАСТРОЙКИ ИМПУЛЬСОВ:
• bodyMovementImpulseChance: 0-10%, базовая частота в покое, по умолчанию 2%
• bodyMovementTalkingImpulseFrequency: 0-30%, частота при разговоре, по умолчанию 15%
• bodyMovementTalkingImpulseMultiplier: 1.0-3.0x, усиление силы при разговоре, по умолчанию 2.0
• bodyMovementTalkingSpeedBoost: 1.0-4.0x, ускорение шумов, по умолчанию 2.0
• bodyMovementImpulseInertia: 0.80-0.98, скорость затухания, по умолчанию 0.92

НАСТРОЙКИ ФИЗИКИ:
• bodyMovementDamping: 0.5-0.99, демпфирование колебаний, по умолчанию 0.85
  (больше = меньше "резинового" отскока)
• bodyMovementSpringStiffness: 0.05-0.30, скорость реакции, по умолчанию 0.15
  (больше = быстрее и резче)

РЕКОМЕНДАЦИИ ДЛЯ СДВГ-ПЕРСОНАЖА:
• Talking Impulse Frequency: 20-25%
• Talking Impulse Multiplier: 2.5-3.0x
• Talking Speed Boost: 2.5-3.5x
• Damping: 0.75-0.82
• Spring Stiffness: 0.20-0.25
• Impulse Decay: 0.85-0.88

MOUTH-LINKED ПАРАМЕТРЫ:
• До 3 дополнительных параметров, связанных с движением рта
• Индивидуальные диапазоны (minValue/maxValue) для каждого
• Сохраняются в characterModelsSettings[character][model_path]['mouth_linked_params']
• Структура: { paramId: '', minValue: 0, maxValue: 30 }

API:
• startBodyMovement(character, model, model_path) - запуск системы
• stopBodyMovement(character) - остановка
• restartBodyMovement(character, model, model_path) - перезапуск
• notifyMouthActivity(character, isActive) - уведомление о движении рта

МОНИТОРИНГ РТА:
• startMouthMonitoring(character, model, model_path) - автозапуск при загрузке
• Отслеживает РЕАЛЬНОЕ значение параметра рта через getParameterValueById
• Вычисляет отклонение от baseline (запоминается при старте)
• Порог активности: deviation > 0.3
• Таймаут idle: 500мс без движения
• Совместимость с TTS audio binding системой

===============================================================================
СИСТЕМА МОРГАНИЯ ГЛАЗАМИ (EYE BLINK) - БИОЛОГИЧЕСКИ ТОЧНАЯ v3.0
===============================================================================

НАЗНАЧЕНИЕ:
• Максимально реалистичная имитация моргания человека
• Основана на научных данных и реальных наблюдениях
• Независимое управление левым и правым глазом
• Множественные типы морганий и микродвижения век

РЕАЛИСТИЧНЫЕ ПАРАМЕТРЫ:
• Частота: 15-20 морганий в минуту (ДИНАМИЧЕСКАЯ!)
• Диапазон интервалов: 2-6 секунд (было 2-8, уменьшено для естественности)
• Средний интервал: 4 секунды (~15 морганий/мин)
• УСКОРЕННАЯ длительность: 50-150мс (было 100-400мс, в среднем 100мс)
• Распределение интервалов: нормальное (Гауссово) для естественности

ДИНАМИЧЕСКИЕ СОСТОЯНИЯ (КЛЮЧЕВАЯ ОСОБЕННОСТЬ):
Частота моргания постоянно меняется, имитируя естественные колебания:

1. FOCUSED (Концентрация) - 20% вероятность:
   • Реже моргает (+40% к интервалам)
   • Длительность состояния: 15-45 секунд
   
2. RELAXED (Расслабленное) - 50% вероятность:
   • Нормальная частота (базовая)
   • Длительность состояния: 20-60 секунд
   
3. DISTRACTED (Отвлечённое) - 20% вероятность:
   • Чаще моргает (-30% к интервалам)
   • Длительность состояния: 10-30 секунд
   
4. TIRED (Усталость) - 10% вероятность:
   • Переменная частота (-15% к интервалам)
   • Длительность состояния: 12-35 секунд

Переключения между состояниями создают НЕПРЕДСКАЗУЕМОСТЬ!

ТИПЫ МОРГАНИЙ (биологически точные):
1. ПОЛНЫЕ МОРГАНИЯ (~85%):
   • Стандартное полное закрытие века
   • Вариативная длительность 50-150мс (УСКОРЕНО)
   
2. ЧАСТИЧНЫЕ МОРГАНИЯ (5%):
   • Неполное закрытие века (40-75% от максимума)
   • Как у реальных людей при лёгкой усталости или концентрации
   • УМЕНЬШЕНА частота с 12% до 5% для естественности
   
3. ДВОЙНЫЕ МОРГАНИЯ (6%):
   • Первое моргание ПОЛНОЕ, второе ЧАСТИЧНОЕ (35-60%) и БЫСТРЕЕ (×1.5)
   • Интервал между ними: 150-400мс
   • Биологически точная имитация рефлекторного моргания
   
4. ТРОЙНЫЕ МОРГАНИЯ (1%):
   • Первое моргание ПОЛНОЕ, второе и третье ЧАСТИЧНЫЕ и БЫСТРЕЕ
   • Имитация раздражения глаз
   • Редкий рефлекс

АСИММЕТРИЧНЫЕ ФАЗЫ (как у реального человека):
• Закрытие века: 40% времени (РЕЗКОЕ - easeInCubic)
• Веко закрыто: 10% времени (пауза)
• Открытие века: 50% времени (ДИНАМИЧНОЕ - easeOutQuart)
• ВАРИАТИВНОСТЬ: ±8% для каждого моргания (устраняет механистичность)
• Агрессивные easing функции имитируют "обрезанный диапазон" параметров
• Закрытие быстрее открытия - как в биологии!

БИОЛОГИЧЕСКИ ТОЧНАЯ СИНХРОННОСТЬ:
• Задержка между глазами: 0-10мс (практически синхронно, было 0-35мс)
• Экспоненциальное распределение (чаще малые, реже большие значения)
• У здоровых людей глаза моргают практически одновременно

МИКРОДВИЖЕНИЯ ВЕК:
• 5% шанс микродвижения при каждой проверке (было 15%, слишком часто)
• Амплитуда: 5% от диапазона движения века
• Длительность: 80мс (очень быстрое подрагивание)
• Интерполяция: easeInOutSine для мягкости
• Добавляет "живость" взгляду между морганиями, но не перегружает

НАСТРОЙКИ:
• eyeBlinkEnabled: bool, по умолчанию true
• eyeBlinkSpeed: 0.5-3.0x, скорость движения век, по умолчанию 1.0
  (0.5 = slow motion, 1.0 = естественно, 3.0 = очень быстро)
  Влияет на длительность, но не на вариативность!

ПАРАМЕТРЫ ДЛЯ КАЖДОГО ГЛАЗА:
• Сохраняются в characterModelsSettings[character][model_path]['eye_blink_params']
• Структура:
  - left_eye: { paramId: '', minValue: 0, maxValue: 1 }
  - right_eye: { paramId: '', minValue: 0, maxValue: 1 }
• minValue = глаз открыт
• maxValue = глаз закрыт
• Параметры индивидуальны для каждого персонажа и модели

API:
• startEyeBlink(character, model, model_path) - запуск системы
• stopEyeBlink(character) - остановка
• restartEyeBlink(character, model, model_path) - перезапуск

ТЕХНИЧЕСКИЕ ДЕТАЛИ:
• Обновление: 60 FPS (16.67мс между кадрами)
• Генерация интервалов: Box-Muller transform для нормального распределения
• Генерация типов морганий: вероятностное распределение
• Проверка состояния модели перед каждым морганием
• Graceful shutdown при удалении модели
• Debug логирование типов морганий (partial/double/triple)

БИОЛОГИЧЕСКАЯ ТОЧНОСТЬ (v3.0 - МАКСИМАЛЬНО РЕАЛИСТИЧНО):
• ✓ УСКОРЕННАЯ длительность морганий (50-150мс вместо 100-400мс)
• ✓ Различные типы морганий (полные/частичные/рефлекторные)
• ✓ ПРАВИЛЬНЫЕ рефлексы: первое моргание полное, последующие частичные и быстрее
• ✓ Асимметрия фаз (закрытие ≠ открытие) + ВАРИАТИВНОСТЬ ±8%
• ✓ БИОЛОГИЧЕСКИ ТОЧНАЯ синхронность глаз (≤10мс вместо ≤35мс)
• ✓ Умеренные микродвижения век (5% вместо 15%)
• ✓ АГРЕССИВНЫЕ easing функции (cubic/quart) имитируют "обрезанный диапазон"
• ✓ Экспоненциальное распределение асинхронности
• ✓ ДИНАМИЧЕСКИЕ СОСТОЯНИЯ - частота моргания постоянно меняется
• ✓ Реалистичные частоты: частичные 5%, двойные 6%, тройные 1%
• ✓ Непредсказуемость через смену состояний каждые 10-60 секунд
• ✓ Сокращён максимальный интервал до 6 секунд (было 8)

===============================================================================
TTS AUDIO BINDING СИСТЕМА
===============================================================================

НАЗНАЧЕНИЕ:
• Интеграция с внешними TTS системами
• Синхронизация движений рта с реальным аудио
• Вместо симуляции по тексту - реальное воспроизведение

МЕХАНИЗМ:
• Внешняя TTS устанавливает window.live2d_tts_bind = true во время аудио
• Персонаж двигает ртом только когда флаг true
• Мониторинг рта отслеживает РЕАЛЬНЫЕ движения и уведомляет Body Movement
• Бесконечный цикл в playTalk с условием `|| true` для работы с TTS

API ДЛЯ ВНЕШНИХ TTS:
```javascript
// Во время воспроизведения аудио:
window.live2d_tts_bind = true;

// Когда аудио заканчивается:
window.live2d_tts_bind = false;
```

ПРЕИМУЩЕСТВА МОНИТОРИНГА:
• Независимость от логики playTalk
• Работает с любыми TTS системами
• Автоматические переходы idle ↔ talking
• Детальное логирование для отладки

===============================================================================
ИНСТРУМЕНТЫ ОТЛАДКИ
===============================================================================

LOG ALL PARAMETERS:
• Выводит все параметры модели в консоль
• Фильтрация body/angle/torso/waist параметров
• Использование: logModelParameters(character)

CUSTOM PARAMETER TESTING:
• Ручное тестирование любого параметра
• Диапазон: -30 до 30
• Слайдер в UI для быстрой настройки
• Использование: setBodyParameter(character, paramId, value)

БЕЗОПАСНОСТЬ:
• Проверка существования параметра перед применением
• Обработка ошибок без спама в консоль

===============================================================================
СИСТЕМА НАСТРОЕК
===============================================================================

ГЛОБАЛЬНЫЕ НАСТРОЙКИ:
• extension_settings.live2d.* - все настройки расширения
• Автосохранение через saveSettingsDebounced()
• Загрузка в loadSettings() с fallback на defaultSettings

ПЕРСОНАЛИЗАЦИЯ:
• characterModelsSettings[character][model_path] - настройки для каждой модели
• Автоматическая инициализация при создании mapping
• Включает: mouth_linked_params, scale, position, animations и т.д.

МИГРАЦИЯ:
• Автоматический перевод старых настроек в новые
• Пример: bodyMovementSmoothness → bodyMovementDamping
• Обратная совместимость сохранена

ДЕФОЛТНЫЕ ЗНАЧЕНИЯ:
• Определены в defaultSettings (index.js)
• Применяются при первой загрузке или отсутствии настройки
• Разумные значения для "из коробки" работы

===============================================================================
КООРДИНАЦИЯ СИСТЕМ
===============================================================================

PLAYТALK → BODY MOVEMENT:
• playTalk() устанавливает window.live2d_tts_bind = false
• Мониторинг рта отслеживает РЕАЛЬНОЕ движение
• notifyMouthActivity(character, true/false) при изменении состояния
• Body Movement переключается между idle/talking

АВТОАНИМАЦИИ:
• Независимы от Body Movement и playTalk
• Управляются через autoAnimationsRunning[character]
• Перезапуск без перезагрузки через restartAutoAnimations()

MOUTH-LINKED PARAMS:
• Читаются Body Movement из characterModelsSettings
• Применяются одновременно с основными движениями
• UI автоматически загружает при выборе модели

===============================================================================
ПРАВИЛА РАЗРАБОТКИ
===============================================================================

ДОБАВЛЕНИЕ НАСТРОЕК:
1. Добавить в defaultSettings (index.js)
2. Создать UI элемент в window.html с префиксом live2d_
3. Добавить обработчик в ui.js и экспортировать
4. Импортировать и привязать в index.js
5. Добавить проверку undefined в loadSettings()

ПЕРСОНАЛИЗИРОВАННЫЕ НАСТРОЙКИ:
• Использовать characterModelsSettings[character][model_path]
• Инициализировать при создании mapping
• Сохранять через saveSettingsDebounced()
• Загружать в loadModelUi()

КОД:
• Подробные комментарии для параметров с диапазонами
• Понятные названия переменных
• Обработка ошибок без спама
• Проверка существования моделей перед операциями

===============================================================================
ТЕКУЩЕЕ СОСТОЯНИЕ
===============================================================================

РЕАЛИЗОВАНО:
✓ Базовая система Live2D с полной поддержкой моделей
✓ Автоматические анимации глаз с микросаккадами
✓ Продвинутая система движений тела с физикой и СДВГ-режимом
✓ Реалистичная система моргания глазами
✓ Настраиваемые mouth-linked параметры (до 3 на персонажа)
✓ Индивидуальные настройки параметров век для каждого глаза
✓ Мониторинг реального движения рта
✓ TTS audio binding для внешней интеграции
✓ Инструменты отладки параметров
✓ Галерея выбора моделей
✓ Персонализированные настройки для каждого персонажа/модели
✓ Автоматическая миграция настроек

КАЧЕСТВО:
• Нет memory leaks при перезагрузке моделей
• Корректное использование Live2D API
• Надежная обработка ошибок
• Подробная документация
• Обратная совместимость

АРХИТЕКТУРА:
• Модульность - каждая система в отдельном файле
• Независимость - системы не зависят друг от друга критически
• Расширяемость - простое добавление новых систем
• Читаемость - понятные названия и документация